name: DevSecOps Pipeline with Monitoring

on:
  push:
    branches: [ "main" ]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3   # ðŸ”¥ REQUIRED

    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      working-directory: ./app
      run: pip install -r requirements.txt

    - name: Compile check
      working-directory: ./app
      run: python -m py_compile app.py


  sast:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v3   # ðŸ”¥ REQUIRED

    - name: Install Bandit
      run: pip install bandit

    - name: Run SAST (fail only on HIGH)
      run: bandit -r app/ -lll
   


  docker:
    runs-on: ubuntu-latest
    needs: sast
    steps:
    - uses: actions/checkout@v3   # ðŸ”¥ REQUIRED

    - run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
    - run: docker build -t ${{ secrets.DOCKER_USERNAME }}/github-demo:latest .
    - run: docker push ${{ secrets.DOCKER_USERNAME }}/github-demo:latest


  container-scan:
    runs-on: ubuntu-latest
    needs: docker
    steps:
    - uses: actions/checkout@v3   # ðŸ”¥ REQUIRED

    - uses: aquasecurity/trivy-action@master
      with:
        image-ref: "${{ secrets.DOCKER_USERNAME }}/github-demo:latest"


  monitoring-setup:
    runs-on: ubuntu-latest
    needs: container-scan
    steps:
    - uses: actions/checkout@v3   # ðŸ”¥ REQUIRED

    - name: Setup kubeconfig
      run: |
        echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > kubeconfig
        echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

    - name: Install Helm
      uses: azure/setup-helm@v3

    - name: Install Monitoring Stack
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
        --namespace monitoring --create-namespace


  deploy:
    runs-on: ubuntu-latest
    needs: monitoring-setup
    steps:
    - uses: actions/checkout@v3   # ðŸ”¥ REQUIRED

    - name: Setup kubeconfig
      run: |
        echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > kubeconfig
        echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

    - name: Deploy App
      run: |
        kubectl apply -f k8s/


  dast:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
    - uses: actions/checkout@v3   # ðŸ”¥ REQUIRED

    - name: Run OWASP ZAP
      run: |
        docker run -t owasp/zap2docker-stable zap-baseline.py \
        -t http://<NODE-IP>:30007 \
        -r report.html
