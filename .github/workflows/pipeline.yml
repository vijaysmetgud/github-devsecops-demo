name: DevSecOps Pipeline with Monitoring

on:
  push:
    branches: [ "main" ]

jobs:

  build:
    runs-on: [self-hosted, Linux, X64]
    steps:
    - uses: actions/checkout@v3

    - name: Install Python & pip if missing
      run: |
        if ! command -v python3 &> /dev/null; then
          sudo apt update
          sudo apt install -y python3 python3-pip
        fi

    - name: Upgrade pip
      run: python3 -m pip install --upgrade pip

    - name: Install dependencies
      run: |
        cd app
        python3 -m pip install -r requirements.txt

    - name: Compile check
      run: |
        cd app
        python3 -m py_compile app.py


  sast:
    runs-on: [self-hosted, Linux, X64]
    needs: build
    steps:
    - uses: actions/checkout@v3

    - name: Install Bandit
      run: python3 -m pip install bandit

    - name: Run SAST (fail only on HIGH)
      run: bandit -r app/ -lll


  docker:
    runs-on: [self-hosted, Linux, X64]
    needs: sast
    steps:
    - uses: actions/checkout@v3

    - name: Login to DockerHub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Build Docker image
      run: docker build -t ${{ secrets.DOCKER_USERNAME }}/github-demo:latest .

    - name: Push Docker image
      run: docker push ${{ secrets.DOCKER_USERNAME }}/github-demo:latest


  container-scan:
    runs-on: [self-hosted, Linux, X64]
    needs: docker
    steps:
    - uses: actions/checkout@v3

    - name: Scan image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: "${{ secrets.DOCKER_USERNAME }}/github-demo:latest"


  monitoring-setup:
    runs-on: [self-hosted, Linux, X64]
    needs: container-scan
    steps:
    - uses: actions/checkout@v3

    - name: Setup kubeconfig
      run: |
        echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > kubeconfig
        chmod 600 kubeconfig
        echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

    - name: Verify Cluster Connectivity
      run: kubectl get nodes

    - name: Install Helm if missing
      run: |
        if ! command -v helm &> /dev/null; then
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi

    - name: Install Monitoring Stack
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
        helm repo update
        helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
          --namespace monitoring --create-namespace

  deploy:
    runs-on: [self-hosted, Linux, X64]
    needs: monitoring-setup
    steps:
    - uses: actions/checkout@v3

    - name: Setup kubeconfig
      run: |
        echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > kubeconfig
        chmod 600 kubeconfig
        echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

    - name: Deploy App
      run: |
        kubectl apply -f k8s/
        kubectl rollout status deployment/github-demo


  dast:
    runs-on: [self-hosted, Linux, X64]
    needs: deploy
    steps:
    - uses: actions/checkout@v3

    - name: Run OWASP ZAP
      run: |
        docker run -t owasp/zap2docker-stable zap-baseline.py \
        -t http://<NODE-IP>:30007 \
        -r report.html
